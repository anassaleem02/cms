<div class="admin-products">
  <app-breadcrumb [items]="[{label:'Admin',link:'/admin'},{label:'Products'}]"></app-breadcrumb>

  <app-confirm-dialog [visible]="deleteDialogVisible" title="Delete Product"
    [message]="'Are you sure you want to delete &quot;' + (productToDelete?.name || '') + '&quot;?'"
    confirmText="Delete" (confirmed)="onDeleteConfirmed()" (cancelled)="deleteDialogVisible=false">
  </app-confirm-dialog>
  <app-confirm-dialog [visible]="bulkDeleteDialogVisible" title="Delete Selected"
    [message]="'Delete ' + selectedIds.size + ' selected products? This cannot be undone.'"
    confirmText="Delete All" (confirmed)="onBulkDeleteConfirmed()" (cancelled)="bulkDeleteDialogVisible=false">
  </app-confirm-dialog>

  <!-- Header -->
  <div class="page-header">
    <h1>Products <span class="count">({{filteredProducts.length}})</span></h1>
    <div class="header-actions">
      <button class="btn btn-outline btn-sm" (click)="exportCsv()">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        Export CSV
      </button>
      <button class="btn btn-primary" (click)="openCreate()">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        Add Product
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      <input type="text" placeholder="Search products..." [(ngModel)]="searchQuery" (input)="applyFilters()">
    </div>
    <select class="filter-select" [(ngModel)]="filterCategory" (change)="applyFilters()">
      <option *ngFor="let c of categories" [value]="c.value">{{c.label}}</option>
    </select>
    <select class="filter-select" [(ngModel)]="filterStatus" (change)="applyFilters()">
      <option value="">All Status</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>
  </div>

  <!-- Bulk Actions Bar -->
  <div class="bulk-bar" *ngIf="selectedIds.size > 0">
    <span>{{selectedIds.size}} selected</span>
    <button class="btn btn-sm" style="background:#EF4444;color:#fff" (click)="bulkDelete()">Delete Selected</button>
    <button class="btn btn-outline btn-sm" (click)="selectedIds.clear()">Clear</button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="products-table-wrapper">
    <div *ngFor="let i of [1,2,3,4]" class="row-skeleton skeleton"></div>
  </div>

  <!-- Table with drag-drop -->
  <div *ngIf="!loading" class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" [checked]="allSelected" (change)="toggleSelectAll()"></th>
          <th>Product</th>
          <th>Category</th>
          <th>Status</th>
          <th>Featured</th>
          <th>Order</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody cdkDropList (cdkDropListDropped)="onDrop($event)">
        <tr *ngFor="let product of filteredProducts" cdkDrag [class.selected]="selectedIds.has(product.id)">
          <td><input type="checkbox" [checked]="selectedIds.has(product.id)" (change)="toggleSelect(product.id)"></td>
          <td>
            <div class="product-cell">
              <img *ngIf="product.primaryImage" [src]="product.primaryImage.imageUrl" [alt]="product.name" class="product-thumb">
              <div class="product-thumb placeholder" *ngIf="!product.primaryImage">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
              </div>
              <div>
                <p class="product-name">{{product.name}}</p>
                <p class="product-desc">{{product.shortDescription | slice:0:60}}...</p>
              </div>
            </div>
          </td>
          <td><span class="badge badge-cat">{{getCategoryLabel(product.category)}}</span></td>
          <td>
            <span class="status-dot" [class.active]="product.isActive" [class.inactive]="!product.isActive">
              {{product.isActive ? 'Active' : 'Inactive'}}
            </span>
          </td>
          <td>
            <span class="featured-star" [class.is-featured]="product.isFeatured">★</span>
          </td>
          <td>
            <span class="drag-handle" cdkDragHandle title="Drag to reorder">⠿</span>
            {{product.displayOrder}}
          </td>
          <td>
            <div class="row-actions">
              <button class="icon-btn" (click)="openEdit(product)" title="Edit">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
              </button>
              <button class="icon-btn" (click)="duplicateProduct(product)" title="Duplicate">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              </button>
              <button class="icon-btn danger" (click)="confirmDelete(product)" title="Delete">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/></svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="empty-row" *ngIf="filteredProducts.length === 0">No products found.</div>
  </div>

  <!-- Product Form Side Panel -->
  <div class="form-overlay" *ngIf="showForm" (click)="closeForm()"></div>
  <div class="form-panel" [class.open]="showForm">
    <div class="form-header">
      <h2>{{editingProduct ? 'Edit Product' : 'New Product'}}</h2>
      <div class="form-header-actions">
        <span class="keyboard-hint">Ctrl+S to save · Esc to close</span>
        <button class="close-btn" (click)="closeForm()">✕</button>
      </div>
    </div>
    <div class="form-body">
      <div class="form-group">
        <label>Product Name *</label>
        <input type="text" [(ngModel)]="form.name" placeholder="e.g. S.O Series 4 KW Inverter">
      </div>
      <div class="form-group">
        <label>Short Description *</label>
        <input type="text" [(ngModel)]="form.shortDescription" placeholder="One-line summary">
      </div>
      <div class="form-group">
        <label>Full Description</label>
        <quill-editor [(ngModel)]="form.description" [styles]="{height: '200px'}"></quill-editor>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Category</label>
          <select [(ngModel)]="form.category">
            <option [value]="ProductCategory.Inverter">Inverter</option>
            <option [value]="ProductCategory.Battery">Battery</option>
            <option [value]="ProductCategory.SolarPanel">Solar Panel</option>
            <option [value]="ProductCategory.Accessory">Accessory</option>
          </select>
        </div>
        <div class="form-group">
          <label>Display Order</label>
          <input type="number" [(ngModel)]="form.displayOrder" min="0">
        </div>
      </div>
      <div class="form-row">
        <label class="toggle-label">
          <input type="checkbox" [(ngModel)]="form.isActive">
          <span>Active</span>
        </label>
        <label class="toggle-label">
          <input type="checkbox" [(ngModel)]="form.isFeatured">
          <span>Featured</span>
        </label>
      </div>
    </div>
    <div class="form-footer">
      <button class="btn btn-outline" (click)="closeForm()">Cancel</button>
      <button class="btn btn-primary" (click)="saveProduct()" [disabled]="saving">
        {{saving ? 'Saving...' : (editingProduct ? 'Update Product' : 'Create Product')}}
      </button>
    </div>
  </div>
</div>
